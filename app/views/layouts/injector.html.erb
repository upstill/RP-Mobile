<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <%= stylesheet_link_tag "foreign/dialog" %>
	<% if true %>
       <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
	<% end %>
    <%= javascript_include_tag "foreign/dialogs" %>
    <%# javascript_include_tag "whenReady" %>
    <%= javascript_include_tag "jquery.ba-postmessage" %>
    <%= csrf_meta_tag %>
	<script type="text/javascript">

	 var _gaq = _gaq || [];
	 _gaq.push(['_setAccount', 'UA-30180298-1']);
	 _gaq.push(['_trackPageview']);

	 (function() {
	   var ga = document.createElement('script'); 
		ga.type = 'text/javascript'; 
		ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0];
		s.parentNode.insertBefore(ga, s);
	 })();
	
	 // Followup for the iframe injection
	$(document).ready(function() {
		// var capsule = window.
		// Set the dialog width to that of the accompanying encapsulation
		var dlog = document.body.childNodes[0];
		while(dlog && dlog.nodeType != 1) {
		  dlog = dlog.nextSibling;
		}
		dlog.width = window.outerWidth;
		var onloadNode = dlog.attributes["onload"];
		if(onloadNode) {
			onloadFcn = onloadNode.nodeValue;
			if (onloadFcn && (typeof window[onloadFcn] === 'function')) {
				window[onloadFcn](dlog);
			}
		}
		setTimeout(function(){
			debugger;
			$.postMessage( "ifrdone", "http://www.htmldog.com/" );
		}, 5000);
        
		/// Cancel will remove the dialog and confirm null effect to user
		var cancelBtn = document.getElementById("recipePowerCancelBtn");
		if(cancelBtn) {
			cancelBtn.onclick = retire_iframe;
		}
		// Finally, report the window dimensions to the server
		var request = "http://localhost:5000/iframe/create.json?url="+encodeURI(window.location.href)+
			"&amp;ifr[width]="+dlog.width+
			"&amp;ifr[height]="+document.height;
		
		var xmlhttp;
		// Send the request using minimal Javascript
		if (window.XMLHttpRequest) { xmlhttp=new XMLHttpRequest(); }
		else {
		  try { xmlhttp = new ActiveXObject("Msxml2.XMLHTTP"); }
		  catch (e) {
			try { xmlhttp = new ActiveXObject("Microsoft.XMLHTTP"); }
			catch (e) { xmlhttp = null; }
		  }
		}
		if(xmlhttp != null) {
		  xmlhttp.open("GET", request, true);
		  xmlhttp.setRequestHeader("Accept", "text/html" );
		  xmlhttp.send();		
		}
	 });

	</script>
  </head>
  <body style="margin:0;">
	<% if flash[:notice] %>
		<div id="notice" class="notice"><%= flash[:notice] %></div>
	<% elsif flash[:alert] %>
		<div class="alert"><%= flash[:alert] %></div>
	<% end %>
	<%= yield %>
  </body>
</html>
