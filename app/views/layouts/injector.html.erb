<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <%= stylesheet_link_tag "foreign/dialog" %>
    <%= stylesheet_link_tag "foreign/RPPicPicker" %>
    <%= stylesheet_link_tag "token-input-facebook" %>
	<% if true %>
       <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
	<% end %>
    <%= javascript_include_tag "foreign/dialogs" %>
    <%# javascript_include_tag "whenReady" %>
    <%= javascript_include_tag "jquery.tokeninput" %>
    <%= javascript_include_tag "jquery.ba-postmessage" %>
    <%= javascript_include_tag "jquery-ui-1.8.17.custom.min.js" %>
    <%= javascript_include_tag "RPPicPicker" %>
    <%= csrf_meta_tag %>
	<script type="text/javascript">

	 var _gaq = _gaq || [];
	 _gaq.push(['_setAccount', 'UA-30180298-1']);
	 _gaq.push(['_trackPageview']);

	 (function() {
	   var ga = document.createElement('script'); 
		ga.type = 'text/javascript'; 
		ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0];
		s.parentNode.insertBefore(ga, s);
	 })();
	
	 // Followup for the iframe injection
	$(document).ready(function() {
		// var capsule = window.
		// Set the dialog width to that of the accompanying encapsulation
		var dlog = document.body.childNodes[0];
		while(dlog && dlog.nodeType != 1) {
		  dlog = dlog.nextSibling;
		}
		dlog.width = window.outerWidth;
		var onloadNode = dlog.attributes["onload"];
		if(onloadNode) {
			onloadFcn = onloadNode.nodeValue;
			if (onloadFcn && (typeof window[onloadFcn] === 'function')) {
				window[onloadFcn](dlog);
			}
		}
        
		/// Cancel will remove the dialog and confirm null effect to user
		var cancelBtn = document.getElementById("recipePowerCancelBtn");
		if(cancelBtn) {
			cancelBtn.onclick = function(){
				$.postMessage( { call: "retire_iframe" }, "<%= params[:sourcehome] %>" );
			};
		}
		// Finally, report the window dimensions to the enclosing window
		debugger;
		$.postMessage( { call: "execute_resize", width: dlog.offsetWidth, height: dlog.offsetHeight }, "<%= params[:sourcehome] %>" );
		
		// Set up jquery tokeninput for the tags
		$("#recipe_tag_tokens").tokenInput("/tags/match.json", {
	        crossDomain: false,
			noResultsText: "No matching tag found; hit Enter to make it a tag",
	        hintText: "Type your own tag(s) for the recipe",
	        prePopulate: $("#recipe_tag_tokens").data("pre"),
	        theme: "facebook",
			preventDuplicates: true,
	        allowFreeTagging: true // allowCustomEntry: true
	    });

		$("#PicPicker").click( function(event) {
			PicPicker("Pick a Logo");
			event.preventDefault();
		})
	    
		$.receiveMessage( function(evt) {
			debugger;
			var data = evt.data;
		})
	 });

	</script>
  </head>
  <body style="margin:0;">
	<% if flash[:notice] %>
		<div id="notice" class="notice"><%= flash[:notice] %></div>
	<% elsif flash[:alert] %>
		<div class="alert"><%= flash[:alert] %></div>
	<% end %>
	<%= yield %>
  </body>
</html>
