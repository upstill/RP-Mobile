<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <%= stylesheet_link_tag "injector" %>
	<% if true %>
       <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
	<% end %>
    <%= javascript_include_tag "injector" %>
    <%= csrf_meta_tag %>
	<script type="text/javascript">

	 var _gaq = _gaq || [];
	 _gaq.push(['_setAccount', 'UA-30180298-1']);
	 _gaq.push(['_trackPageview']);

	 (function() {
	   var ga = document.createElement('script'); 
		ga.type = 'text/javascript'; 
		ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0];
		s.parentNode.insertBefore(ga, s);
	 })();
	
	function retire_iframe() {
		$.postMessage( { call: "retire_iframe" }, "<%= params[:sourcehome] %>" );
	}
	
	 // Followup for the iframe injection
	$(document).ready(function() {
		// var capsule = window.
		// Set the dialog width to that of the accompanying encapsulation
		var dlog = document.getElementById("recipePowerDialog"); // document.body.childNodes[0];
		var onloadNode = dlog.attributes["onload"];
		if(onloadNode) {
			onloadFcn = onloadNode.nodeValue;
			if (onloadFcn && (typeof window[onloadFcn] === 'function')) {
				window[onloadFcn](dlog);
			}
		}
        
		/// Cancel will remove the dialog and confirm null effect to user
		
		var cancelBtn = document.getElementById("recipePowerCancelBtn");
		if(cancelBtn) cancelBtn.onclick = retire_iframe;
		debugger;
		$('form', dlog).submit( dlog, submitDialog );
			
		// Finally, report the window dimensions to the enclosing window
		$.postMessage( { call: "execute_resize", width: dlog.offsetWidth, height: dlog.offsetHeight }, "<%= params[:sourcehome] %>" );
		
		// Set up jquery tokeninput for the tags
		$("#recipe_tag_tokens").tokenInput("/tags/match.json", {
			crossDomain: false,
			noResultsText: "No matching tag found; hit Enter to make it a tag",
			hintText: "Type your own tag(s) for the recipe",
			prePopulate: $("#recipe_tag_tokens").data("pre"),
			theme: "facebook",
			preventDuplicates: true,
			allowFreeTagging: true // allowCustomEntry: true
		});
/*
		$("#PicPicker").click( function(event) {
			PicPicker("Pick a Logo");
			event.preventDefault();
		})
*/
	  // Function for cracking param string
		window.ptq = function(q) {
			/* parse the message */
			/* semicolons are nonstandard but we accept them */
			var x = q.replace(/;/g, '&').split('&'), i, name, t;
			/* q changes from string version of query to object */
			for (q={}, i=0; i<x.length; i++) {
				t = x[i].split('=', 2);
				name = unescape(t[0]);
				if (!q[name])
					q[name] = [];
				if (t.length > 1) {
					q[name][q[name].length] = unescape(t[1]);
				} else
				/* next two lines are nonstandard */
					q[name][q[name].length] = true;
			}
			return q;
		}
	    
		$.receiveMessage( function(evt) {
			var data = window.ptq(evt.data);
			var call = data.call;
			if(call && (typeof window[call] === 'function')) {
				window[call](data);
			}
		})
	 });

	</script>
  </head>
  <body style="margin:0;">
	<% if flash[:notice] %>
		<div id="notice" class="notice"><%= flash[:notice] %></div>
	<% elsif flash[:alert] %>
		<div class="alert"><%= flash[:alert] %></div>
	<% end %>
	<%= yield %>
  </body>
</html>
